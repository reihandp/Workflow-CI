name: CI Heart Failure

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 0. Set up job
      - name: Set up job
        run: |
          echo "Starting job..."
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Branch: ${{ github.ref_name }}"
          # Pastikan MLflow menulis ke mlruns di root repo
          echo "MLFLOW_TRACKING_URI=file:${{ github.workspace }}/mlruns" >> $GITHUB_ENV
          echo "PYTHONUNBUFFERED=1" >> $GITHUB_ENV

      # 1. Ambil kode dari repository
      - name: Run actions/checkout@v3
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: true

      # 2. Setup Python 3.12.7
      - name: Set up Python 3.12.7
        uses: actions/setup-python@v4
        with:
          python-version: "3.12.7"
          cache: "pip"

      # 3. Cek apakah variabel env sudah oke
      - name: Check Env
        run: |
          python --version
          pip --version
          echo "MLFLOW_TRACKING_URI: $MLFLOW_TRACKING_URI"
          echo "Runner OS: ${{ runner.os }}"

      # 4. Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mlflow pandas scikit-learn

      # 5. Jalankan project MLflow
      - name: Run mlflow project
        env:
          MLFLOW_TRACKING_URI: file:${{ github.workspace }}/mlruns
        run: |
          mlflow --version
          mlflow run MLProject --env-manager=local

      # 6. Get latest MLflow run_id
      - name: Get latest MLflow run_id
        id: latest_run
        env:
          MLFLOW_TRACKING_URI: file:${{ github.workspace }}/mlruns
        run: |
          python - <<'PY'
          import os
          from mlflow.tracking import MlflowClient
          client = MlflowClient()
          exps = client.list_experiments()
          exp_id = None
          # Gunakan "Default" jika ada, kalau tidak ambil yang pertama
          for e in exps:
              if e.name == "Default":
                  exp_id = e.experiment_id
                  break
          if exp_id is None and exps:
              exp_id = exps[0].experiment_id
          run_id = ""
          if exp_id is not None:
              runs = client.search_runs([exp_id], order_by=["attributes.start_time DESC"], max_results=1)
              if runs:
                  run_id = runs[0].info.run_id
          print(f"Latest run_id: {run_id}")
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"run_id={run_id}\n")
          PY

      - name: Show latest run_id
        run: echo "Latest MLflow run_id is: ${{ steps.latest_run.outputs.run_id }}"

      # 7. Simpan hasil (mlruns) balik ke GitHub
      - name: Save mlruns to repo
        run: |
          git config --global user.name "${{ secrets.username }}"
          git config --global user.email "${{ secrets.email }}"
          if [ -d "mlruns" ]; then
            git add mlruns/
            git commit -m "Save mlruns from CI run ${{ steps.latest_run.outputs.run_id }}" || true
            git push origin main || true
          else
            echo "mlruns directory not found at repo root"
          fi
